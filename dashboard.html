<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - QubeNode Validator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            border: 1px solid rgba(0,212,255,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .btn-quick {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-delegate {
            background: linear-gradient(135deg, #00D4FF, #00FFF0);
            color: #000;
        }
        
        .btn-claim-all {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .delegation-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .delegation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .validator-name {
            font-size: 18px;
            font-weight: 600;
            color: #00D4FF;
        }
        
        .delegation-amount {
            font-size: 20px;
            font-weight: 600;
            color: #00FFF0;
        }
        
        .pending-rewards {
            color: #86efac;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .delegation-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .btn-action {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-stake {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }
        
        .btn-switch {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .btn-unbond {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            margin: 3% auto;
            padding: 0;
            border: 2px solid rgba(0,212,255,0.4);
            border-radius: 20px;
            width: 90%;
            max-width: 520px;
            box-shadow: 0 20px 60px rgba(0,212,255,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .close {
            position: absolute;
            right: 24px;
            color: #64748b;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #ef4444;
        }
        
        .modal-body {
            padding: 28px;
        }
        
        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            gap: 12px;
        }
        
        .validator-info-box {
            background: rgba(0,212,255,0.08);
            border: 1px solid rgba(0,212,255,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .validator-list-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .validator-list-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(0,212,255,0.5);
        }
        
        .validator-list-item.selected {
            background: rgba(0,212,255,0.15);
            border-color: rgba(0,212,255,0.6);
        }
        
        .warning-box {
            background: rgba(245,158,11,0.08);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 20px;
        }
        
        .warning-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fbbf24;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .warning-item:last-child {
            margin-bottom: 0;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border: 2px solid rgba(0,212,255,0.3);
            border-radius: 12px;
            color: white;
            font-size: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: rgba(0,212,255,0.6);
            background: rgba(255,255,255,0.05);
        }
        
        select {
            width: 100%;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
        }
        
        .btn-cancel {
            flex: 1;
            padding: 14px;
            background: #475569;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel:hover {
            background: #5a6a7f;
        }
        
        .btn-confirm {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirm.cyan {
            background: linear-gradient(135deg, #00D4FF, #00FFF0);
            color: #000;
        }
        
        .btn-confirm.green {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .btn-confirm.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .rewards-list {
            background: rgba(245,158,11,0.05);
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .reward-item:last-child {
            border-bottom: none;
        }
        
        .total-rewards {
            background: rgba(245,158,11,0.15);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .total-rewards-label {
            color: #fbbf24;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .total-rewards-amount {
            color: #fbbf24;
            font-size: 32px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 style="color: #00D4FF; margin-bottom: 10px;">üíé –í–∞—à —Å—Ç–µ–π–∫—ñ–Ω–≥ –¥–∞—à–±–æ—Ä–¥</h1>
            <p style="color: #64748b;">–ê–¥—Ä–µ—Å–∞: <span id="walletAddress">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></p>
            <button onclick="disconnectWallet()" style="margin-top: 16px; padding: 10px 20px; background: #ef4444; border: none; border-radius: 8px; color: white; cursor: pointer;">üö™ –í—ñ–¥'—î–¥–Ω–∞—Ç–∏ –≥–∞–º–∞–Ω–µ—Ü—å</button>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card" style="border-color: rgba(0,212,255,0.3);">
                <div class="stat-label">üí∞ –ë–ê–õ–ê–ù–°</div>
                <div class="stat-value" style="color: #00D4FF;"><span id="balance">0.000</span> TICS</div>
            </div>
            <div class="stat-card" style="border-color: rgba(34,197,94,0.3);">
                <div class="stat-label">üíé –î–ï–õ–ï–ì–û–í–ê–ù–û</div>
                <div class="stat-value" style="color: #22c55e;"><span id="delegated">0.000</span> TICS</div>
            </div>
            <div class="stat-card" style="border-color: rgba(245,158,11,0.3);">
                <div class="stat-label">‚ú® –í–ò–ù–ê–ì–û–†–û–î–ò</div>
                <div class="stat-value" style="color: #f59e0b;"><span id="rewards">0.000</span> TICS</div>
            </div>
            <div class="stat-card" style="border-color: rgba(239,68,68,0.3);">
                <div class="stat-label">‚è≥ UNBONDING</div>
                <div class="stat-value" style="color: #ef4444;"><span id="unbonding">0.000</span> TICS</div>
            </div>
        </div>
        
        <!-- Forecast -->
        <div class="section">
            <h4 class="section-title">üìä –ü—Ä–æ–≥–Ω–æ–∑ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥</h4>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">–ù–∞ –¥–µ–Ω—å</div>
                    <div class="stat-value" style="color: #86efac; font-size: 18px;"><span id="forecastDaily">0.000</span> TICS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ù–∞ —Ç–∏–∂–¥–µ–Ω—å</div>
                    <div class="stat-value" style="color: #86efac; font-size: 18px;"><span id="forecastWeekly">0.000</span> TICS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ù–∞ –º—ñ—Å—è—Ü—å</div>
                    <div class="stat-value" style="color: #86efac; font-size: 18px;"><span id="forecastMonthly">0.000</span> TICS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ù–∞ —Ä—ñ–∫</div>
                    <div class="stat-value" style="color: #86efac; font-size: 18px;"><span id="forecastYearly">0.000</span> TICS</div>
                </div>
            </div>
            <p style="color: #64748b; font-size: 12px; margin-top: 16px;">* APY ~30%, –∫–æ–º—ñ—Å—ñ—è –≤–∞–ª—ñ–¥–∞—Ç–æ—Ä–∞ –≤–∂–µ –≤—Ä–∞—Ö–æ–≤–∞–Ω–∞. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–∞–≤–µ–¥–µ–Ω–æ –±–µ–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–æ–≥–æ –≤—ñ–¥—Å–æ—Ç–∫–∞.</p>
        </div>
        
        <!-- Quick Actions -->
        <div class="section">
            <h4 class="section-title">üíé –®–≤–∏–¥–∫—ñ –¥—ñ—ó</h4>
            <div class="quick-actions">
                <button class="btn-quick btn-delegate" onclick="quickDelegateQubeNode()">
                    üöÄ –î–µ–ª–µ–≥—É–≤–∞—Ç–∏ –Ω–∞ QubeNode
                </button>
                <button class="btn-quick btn-claim-all" onclick="quickClaimAll()">
                    üí∞ –ó–∞–±—Ä–∞—Ç–∏ –≤—Å—ñ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏ (<span id="quickClaimAmount">0.000</span> TICS)
                </button>
            </div>
        </div>
        
        <!-- My Delegations -->
        <div class="section">
            <h4 class="section-title">üìã –ú–æ—ó –¥–µ–ª–µ–≥–∞—Ü—ñ—ó</h4>
            <div id="delegationsList">
                <div style="text-align: center; color: #64748b; padding: 20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ–ª–µ–≥–∞—Ü—ñ–π...</div>
            </div>
        </div>
        
        <!-- Unbonding Delegations -->
        <div class="section" id="unbondingSection" style="display: none;">
            <h4 class="section-title" style="color: #ef4444;">‚è≥ Unbonding Delegations</h4>
            <div id="unbondingList"></div>
        </div>
    </div>
    
    <!-- MODALS -->
    
    <!-- Stake More / Delegate Modal -->
    <div id="stakeMoreModal" class="modal">
        <div class="modal-content" style="border-color: rgba(0,212,255,0.4);">
            <div class="modal-header">
                <h3 style="color: #00D4FF;">üíé –î–µ–ª–µ–≥—É–≤–∞—Ç–∏ TICS</h3>
                <span class="close" onclick="closeModal('stakeMoreModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="validator-info-box">
                    <div style="color: #00D4FF; font-size: 18px; font-weight: 600; margin-bottom: 4px;" id="stakeMoreValidatorName"></div>
                    <div style="color: #64748b; font-size: 13px; word-break: break-all;" id="stakeMoreValidatorAddr"></div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="color: #94a3b8; font-size: 14px; display: block; margin-bottom: 8px;">–°—É–º–∞ –¥–ª—è –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è (TICS)</label>
                    <input type="number" id="stakeMoreAmount" placeholder="0.00" step="0.001">
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; color: #64748b; font-size: 13px;">
                    <span>–ú—ñ–Ω—ñ–º—É–º: 0.1 TICS</span>
                    <span>–î–æ—Å—Ç—É–ø–Ω–æ: <span id="stakeMoreAvailable">0.000</span> TICS</span>
                </div>
                
                <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px; padding: 14px;">
                    <label style="display: flex; align-items: center; cursor: pointer; color: #86efac; font-size: 14px;">
                        <input type="checkbox" checked style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                        <span>–ü–æ—á–Ω–µ—Ç–µ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('stakeMoreModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn-confirm cyan" onclick="confirmStakeMore()">–î–µ–ª–µ–≥—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <!-- Claim All Rewards Modal -->
    <div id="claimAllModal" class="modal">
        <div class="modal-content" style="border-color: rgba(245,158,11,0.4);">
            <div class="modal-header">
                <h3 style="color: #fbbf24;">üí∞ Claim Rewards</h3>
                <span class="close" onclick="closeModal('claimAllModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="total-rewards">
                    <div class="total-rewards-label">Total Rewards:</div>
                    <div class="total-rewards-amount"><span id="claimTotalAmount">0.0000</span> TICS</div>
                </div>
                
                <div style="margin-bottom: 16px; color: #94a3b8; font-size: 14px;">Rewards from validators:</div>
                <div class="rewards-list" id="claimRewardsList"></div>
                
                <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px; padding: 14px;">
                    <label style="display: flex; align-items: center; cursor: pointer; color: #86efac; font-size: 14px;">
                        <input type="checkbox" checked style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                        <span>All rewards will be claimed in one transaction</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('claimAllModal')">Cancel</button>
                <button class="btn-confirm green" onclick="confirmClaimAll()">Claim</button>
            </div>
        </div>
    </div>
    
    <!-- Switch Validator Modal - Step 1 -->
    <div id="switchValidatorModal" class="modal">
        <div class="modal-content" style="border-color: rgba(0,212,255,0.4);">
            <div class="modal-header">
                <h3 style="color: #00D4FF;">üîÑ Switch Validator</h3>
                <span class="close" onclick="closeModal('switchValidatorModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <div style="color: #00D4FF; font-size: 14px; margin-bottom: 8px;">From:</div>
                    <div class="validator-info-box">
                        <div style="color: #00D4FF; font-size: 18px; font-weight: 600; margin-bottom: 4px;" id="switchFromValidatorName"></div>
                        <div style="color: #94a3b8; font-size: 13px;">Staked: <span id="switchFromStaked">0.0000</span> TICS</div>
                    </div>
                </div>
                
                <div style="color: #94a3b8; font-size: 14px; margin-bottom: 12px;">Select Validator:</div>
                <div id="validatorsList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('switchValidatorModal')">Cancel</button>
                <button class="btn-confirm cyan" onclick="switchValidatorStep2()">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Switch Validator Modal - Step 2 -->
    <div id="switchValidatorModal2" class="modal">
        <div class="modal-content" style="border-color: rgba(0,212,255,0.4);">
            <div class="modal-header">
                <h3 style="color: #00D4FF;">üîÑ Switch Validator</h3>
                <span class="close" onclick="closeModal('switchValidatorModal2')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <div style="color: #00D4FF; font-size: 14px; margin-bottom: 8px;">From:</div>
                    <div class="validator-info-box">
                        <div style="color: #00D4FF; font-size: 18px; font-weight: 600; margin-bottom: 4px;" id="switchFromValidatorName2"></div>
                        <div style="color: #94a3b8; font-size: 13px;">Staked: <span id="switchFromStaked2">0.0000</span> TICS</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="color: #00D4FF; font-size: 14px; margin-bottom: 8px;">Select Validator:</div>
                    <div class="validator-info-box">
                        <div style="color: #00D4FF; font-size: 16px; font-weight: 600;" id="switchToValidatorName"></div>
                        <div style="color: #94a3b8; font-size: 12px; word-break: break-all;" id="switchToValidatorAddr"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="color: #94a3b8; font-size: 14px; display: block; margin-bottom: 8px;">Amount (TICS)</label>
                    <input type="number" id="switchAmount" placeholder="0.00" step="0.001">
                </div>
                
                <div style="text-align: right; margin-bottom: 20px; color: #64748b; font-size: 13px;">
                    Maximum: <span id="switchMaxAmount">0.0000</span> TICS
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('switchValidatorModal2')">Cancel</button>
                <button class="btn-confirm cyan" onclick="confirmSwitch()">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Unbond Modal -->
    <div id="unbondModal" class="modal">
        <div class="modal-content" style="border-color: rgba(239,68,68,0.4);">
            <div class="modal-header">
                <h3 style="color: #ef4444;">üîì Unstake TICS</h3>
                <span class="close" onclick="closeModal('unbondModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="validator-info-box" style="background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.2);">
                    <div style="color: #ef4444; font-size: 18px; font-weight: 600; margin-bottom: 4px;" id="unbondValidatorName"></div>
                    <div style="color: #94a3b8; font-size: 13px;">Staked: <span id="unbondStaked">0.0000</span> TICS</div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="color: #94a3b8; font-size: 14px; display: block; margin-bottom: 8px;">Amount (TICS)</label>
                    <input type="number" id="unbondAmount" placeholder="0.00" step="0.001" style="border-color: rgba(239,68,68,0.3);">
                </div>
                
                <div style="text-align: right; margin-bottom: 20px; color: #64748b; font-size: 13px;">
                    Staked: <span id="unbondMaxAmount">0.0000</span> TICS
                </div>
                
                <div class="warning-box">
                    <div class="warning-item">‚ö†Ô∏è You will NOT earn rewards during unbonding</div>
                    <div class="warning-item">‚ö†Ô∏è Tokens will be locked for 14 days</div>
                    <div class="warning-item">‚ö†Ô∏è You can cancel unbonding before completion</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('unbondModal')">Cancel</button>
                <button class="btn-confirm red" onclick="confirmUnbond()">Unstake</button>
            </div>
        </div>
    </div>
    
    <script>
        const QUBENODE_VALIDATOR = 'qubeticsvaloper1tzk9f84cv2gmk3du3m9dpxcuph70sfj6uf6kld';
        let cosmosStaking = null;
        let validatorNamesCache = {};
        let currentValidatorAddress = '';
        let selectedSwitchValidator = '';
        let allValidators = [];
        
        // Initialize
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const walletType = urlParams.get('wallet');
            const address = urlParams.get('address');
            
            if (!walletType || !address) {
                alert('–ù–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≥–∞–º–∞–Ω–µ—Ü—å. –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—É.');
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('walletAddress').textContent = address.substring(0, 20) + '...';
            
            // Wait for modules
            let attempts = 0;
            while (typeof CosmosStakingModule === 'undefined' && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (typeof CosmosStakingModule === 'undefined') {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤');
                return;
            }
            
            cosmosStaking = new CosmosStakingModule();
            await cosmosStaking.initialize();
            
            const result = await cosmosStaking.connectWallet(walletType);
            if (!result.success) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è');
                return;
            }
            
            await loadData();
        }
        
        async function loadData() {
            try {
                const overview = await cosmosStaking.refresh();
                
                // Update stats
                document.getElementById('balance').textContent = formatTics(overview.balance);
                document.getElementById('delegated').textContent = formatTics(overview.totalDelegated);
                document.getElementById('rewards').textContent = formatTics(overview.totalRewards);
                document.getElementById('unbonding').textContent = formatTics(overview.totalUnbonding);
                document.getElementById('quickClaimAmount').textContent = formatTics(overview.totalRewards);
                
                // Forecast
                const delegated = parseFloat(overview.totalDelegated) / 1e18;
                const apy = 0.285;
                const daily = (delegated * apy) / 365;
                document.getElementById('forecastDaily').textContent = daily.toFixed(3);
                document.getElementById('forecastWeekly').textContent = (daily * 7).toFixed(3);
                document.getElementById('forecastMonthly').textContent = (daily * 30).toFixed(3);
                document.getElementById('forecastYearly').textContent = (delegated * apy).toFixed(3);
                
                await loadDelegations(overview);
                await loadUnbonding(overview);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ' + error.message);
            }
        }
        
        async function loadDelegations(overview) {
            const container = document.getElementById('delegationsList');
            
            if (!overview.delegations || overview.delegations.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">–î–µ–ª–µ–≥–∞—Ü—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }
            
            let html = '';
            
            for (const del of overview.delegations) {
                const valAddr = del.delegation.validator_address;
                const amount = formatTics(del.balance.amount);
                
                let valName = validatorNamesCache[valAddr] || '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                if (!validatorNamesCache[valAddr]) {
                    loadValidatorName(valAddr);
                }
                
                let rewards = '0.000';
                if (overview.rewards && overview.rewards.rewards) {
                    const rewardEntry = overview.rewards.rewards.find(r => r.validator_address === valAddr);
                    if (rewardEntry && rewardEntry.reward && rewardEntry.reward.length > 0) {
                        const ticsReward = rewardEntry.reward.find(r => r.denom === 'tics');
                        if (ticsReward) {
                            rewards = formatTics(ticsReward.amount);
                        }
                    }
                }
                
                html += `
                    <div class="delegation-item">
                        <div class="delegation-header">
                            <div>
                                <div class="validator-name">${valName}</div>
                                <div style="color: #64748b; font-size: 12px; margin-top: 4px;">${valAddr.substring(0, 25)}...</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="delegation-amount">${amount} TICS</div>
                                <div class="pending-rewards">üí∞ Pending Rewards<br>${rewards} TICS</div>
                            </div>
                        </div>
                        <div class="delegation-actions">
                            <button class="btn-action btn-stake" onclick="stakeMore('${valAddr}', '${amount}')">üíé Stake More</button>
                            <button class="btn-action btn-switch" onclick="switchValidator('${valAddr}', '${amount}')">üîÑ Switch Validator</button>
                            <button class="btn-action btn-unbond" onclick="unbond('${valAddr}', '${amount}')">üîì Unbond</button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function loadValidatorName(address) {
            try {
                const response = await fetch(`https://swagger.qubetics.com/cosmos/staking/v1beta1/validators/${address}`);
                const data = await response.json();
                if (data.validator && data.validator.description) {
                    validatorNamesCache[address] = data.validator.description.moniker || address;
                    await loadData();
                }
            } catch (error) {
                console.error('Error loading validator name:', error);
            }
        }
        
        async function loadUnbonding(overview) {
            const section = document.getElementById('unbondingSection');
            const container = document.getElementById('unbondingList');
            
            if (!overview.unbondingDelegations || overview.unbondingDelegations.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            let html = '';
            
            for (const unbonding of overview.unbondingDelegations) {
                const valAddr = unbonding.validator_address;
                let valName = validatorNamesCache[valAddr] || '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                if (!validatorNamesCache[valAddr]) {
                    loadValidatorName(valAddr);
                }
                
                for (const entry of unbonding.entries) {
                    const amount = formatTics(entry.balance);
                    const completionTime = new Date(entry.completion_time);
                    const now = new Date();
                    const daysLeft = Math.ceil((completionTime - now) / (1000 * 60 * 60 * 24));
                    const hoursLeft = Math.ceil((completionTime - now) / (1000 * 60 * 60));
                    const creationHeight = entry.creation_height || entry.initial_balance;
                    
                    html += `
                        <div class="delegation-item" style="border-color: rgba(239,68,68,0.3);">
                            <div style="color: #ef4444; font-size: 20px; font-weight: 600; margin-bottom: 8px;">${amount} TICS</div>
                            <div style="color: #94a3b8; margin-bottom: 4px;">From: ${valName}</div>
                            <div style="color: #64748b; font-size: 12px; margin-bottom: 12px;">${valAddr}</div>
                            <div style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                <div style="color: #fca5a5; font-size: 14px; margin-bottom: 4px;">Time Remaining</div>
                                <div style="color: #ef4444; font-size: 18px; font-weight: 600;">${hoursLeft}h</div>
                                <div style="color: #64748b; font-size: 12px; margin-top: 4px;">Completion: ${completionTime.toLocaleDateString('uk-UA')}, ${completionTime.toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                            ${daysLeft > 0 ? `<button onclick="cancelUnbonding('${valAddr}', '${entry.balance}', '${creationHeight}')" style="width: 100%; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: #ef4444; cursor: pointer; font-weight: 600;">Cancel Unbonding</button>` : ''}
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }
        
        function formatTics(amount) {
            const tics = parseFloat(amount) / 1e18;
            return tics.toFixed(3);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Stake More
        function stakeMore(validatorAddress, stakedAmount) {
            console.log('üéØ Stake More clicked for:', validatorAddress);
            currentValidatorAddress = validatorAddress;
            
            const valName = validatorNamesCache[validatorAddress] || validatorAddress;
            document.getElementById('stakeMoreValidatorName').textContent = valName;
            document.getElementById('stakeMoreValidatorAddr').textContent = validatorAddress;
            
            const balance = document.getElementById('balance').textContent;
            document.getElementById('stakeMoreAvailable').textContent = balance;
            document.getElementById('stakeMoreAmount').value = '';
            
            document.getElementById('stakeMoreModal').style.display = 'block';
        }
        
        async function confirmStakeMore() {
            const amount = document.getElementById('stakeMoreAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) < 0.1) {
                alert('–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—É–º–∞: 0.1 TICS');
                return;
            }
            
            closeModal('stakeMoreModal');
            
            try {
                const amountMinimal = (parseFloat(amount) * 1e18).toString();
                
                console.log('üì§ Delegating to:', currentValidatorAddress);
                console.log('üí∞ Amount:', amount, 'TICS');
                
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const result = await stakingService.delegate(currentValidatorAddress, amountMinimal, 'Stake more via QubeNode.space');
                
                alert('‚úÖ –£—Å–ø—ñ—à–Ω–æ! TX: ' + result.txHash);
                await loadData();
            } catch (error) {
                console.error('Stake error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        // Quick Delegate to QubeNode
        function quickDelegateQubeNode() {
            stakeMore(QUBENODE_VALIDATOR, '0');
        }
        
        // Claim All
        async function quickClaimAll() {
            try {
                const overview = await cosmosStaking.refresh();
                
                if (!overview.rewards || !overview.rewards.rewards || overview.rewards.rewards.length === 0) {
                    alert('–ù–µ–º–∞—î –≤–∏–Ω–∞–≥–æ—Ä–æ–¥ –¥–ª—è –∑–±–æ—Ä—É');
                    return;
                }
                
                // Fill modal
                document.getElementById('claimTotalAmount').textContent = formatTics(overview.totalRewards);
                
                let rewardsHtml = '';
                for (const reward of overview.rewards.rewards) {
                    const valAddr = reward.validator_address;
                    const valName = validatorNamesCache[valAddr] || valAddr.substring(0, 20) + '...';
                    
                    if (reward.reward && reward.reward.length > 0) {
                        const ticsReward = reward.reward.find(r => r.denom === 'tics');
                        if (ticsReward) {
                            const rewardAmount = formatTics(ticsReward.amount);
                            rewardsHtml += `
                                <div class="reward-item">
                                    <div style="color: white; font-weight: 500;">${valName}</div>
                                    <div style="color: #fbbf24; font-weight: 600;">${rewardAmount} TICS</div>
                                </div>
                            `;
                        }
                    }
                }
                
                document.getElementById('claimRewardsList').innerHTML = rewardsHtml;
                document.getElementById('claimAllModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        async function confirmClaimAll() {
            closeModal('claimAllModal');
            
            try {
                const result = await cosmosStaking.claimRewards('Claim all via QubeNode.space');
                alert('‚úÖ –í–∏–Ω–∞–≥–æ—Ä–æ–¥–∏ –∑—ñ–±—Ä–∞–Ω–æ! TX: ' + result.txHash);
                await loadData();
            } catch (error) {
                console.error('Claim error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        // Switch Validator
        async function switchValidator(validatorAddress, stakedAmount) {
            console.log('üîÑ Switch Validator clicked for:', validatorAddress);
            currentValidatorAddress = validatorAddress;
            
            const valName = validatorNamesCache[validatorAddress] || validatorAddress;
            document.getElementById('switchFromValidatorName').textContent = valName;
            document.getElementById('switchFromStaked').textContent = stakedAmount;
            
            // Load all validators
            await loadAllValidators();
            
            document.getElementById('switchValidatorModal').style.display = 'block';
        }
        
        async function loadAllValidators() {
            try {
                const response = await fetch('https://swagger.qubetics.com/cosmos/staking/v1beta1/validators?status=BOND_STATUS_BONDED');
                const data = await response.json();
                allValidators = data.validators || [];
                
                let html = '';
                for (const val of allValidators) {
                    if (val.operator_address !== currentValidatorAddress) {
                        const name = val.description.moniker || val.operator_address;
                        const commission = (parseFloat(val.commission.commission_rates.rate) * 100).toFixed(2);
                        html += `
                            <div class="validator-list-item" onclick="selectValidator('${val.operator_address}', '${name}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: white; font-weight: 600; margin-bottom: 4px;">${name}</div>
                                        <div style="color: #64748b; font-size: 12px;">${val.operator_address.substring(0, 30)}...</div>
                                    </div>
                                    <div style="color: #94a3b8; font-size: 13px;">–ö–æ–º—ñ—Å—ñ—è: ${commission}%</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                document.getElementById('validatorsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading validators:', error);
            }
        }
        
        function selectValidator(address, name) {
            selectedSwitchValidator = address;
            
            // Highlight selected
            document.querySelectorAll('.validator-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }
        
        function switchValidatorStep2() {
            if (!selectedSwitchValidator) {
                alert('–í–∏–±–µ—Ä—ñ—Ç—å –≤–∞–ª—ñ–¥–∞—Ç–æ—Ä–∞');
                return;
            }
            
            closeModal('switchValidatorModal');
            
            // Fill step 2
            const fromName = validatorNamesCache[currentValidatorAddress] || currentValidatorAddress;
            const stakedAmount = document.getElementById('switchFromStaked').textContent;
            const toName = validatorNamesCache[selectedSwitchValidator] || selectedSwitchValidator;
            
            document.getElementById('switchFromValidatorName2').textContent = fromName;
            document.getElementById('switchFromStaked2').textContent = stakedAmount;
            document.getElementById('switchToValidatorName').textContent = toName;
            document.getElementById('switchToValidatorAddr').textContent = selectedSwitchValidator;
            document.getElementById('switchMaxAmount').textContent = stakedAmount;
            document.getElementById('switchAmount').value = '';
            
            document.getElementById('switchValidatorModal2').style.display = 'block';
        }
        
        async function confirmSwitch() {
            const amount = document.getElementById('switchAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å');
                return;
            }
            
            closeModal('switchValidatorModal2');
            
            try {
                const amountMinimal = (parseFloat(amount) * 1e18).toString();
                
                console.log('üì§ Redelegating from:', currentValidatorAddress);
                console.log('üì• Redelegating to:', selectedSwitchValidator);
                console.log('üí∞ Amount:', amount, 'TICS');
                
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const result = await stakingService.redelegate(currentValidatorAddress, selectedSwitchValidator, amountMinimal, 'Switch validator via QubeNode.space');
                
                alert('‚úÖ –£—Å–ø—ñ—à–Ω–æ! TX: ' + result.txHash);
                await loadData();
            } catch (error) {
                console.error('Redelegate error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        // Unbond
        function unbond(validatorAddress, stakedAmount) {
            console.log('‚õî Unbond clicked for:', validatorAddress);
            currentValidatorAddress = validatorAddress;
            
            const valName = validatorNamesCache[validatorAddress] || validatorAddress;
            document.getElementById('unbondValidatorName').textContent = valName;
            document.getElementById('unbondStaked').textContent = stakedAmount;
            document.getElementById('unbondMaxAmount').textContent = stakedAmount;
            document.getElementById('unbondAmount').value = '';
            
            document.getElementById('unbondModal').style.display = 'block';
        }
        
        async function confirmUnbond() {
            const amount = document.getElementById('unbondAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å');
                return;
            }
            
            closeModal('unbondModal');
            
            try {
                const amountMinimal = (parseFloat(amount) * 1e18).toString();
                
                console.log('üì§ Unbonding from:', currentValidatorAddress);
                console.log('üí∞ Amount:', amount, 'TICS');
                
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const result = await stakingService.undelegate(currentValidatorAddress, amountMinimal, 'Unbond via QubeNode.space');
                
                alert('‚úÖ Unbond —Ä–æ–∑–ø–æ—á–∞—Ç–æ! TX: ' + result.txHash);
                await loadData();
            } catch (error) {
                console.error('Unbond error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        // Cancel Unbonding
        async function cancelUnbonding(validatorAddress, amount, creationHeight) {
            if (!confirm(`–°–∫–∞—Å—É–≤–∞—Ç–∏ unbond ${formatTics(amount)} TICS? –¢–æ–∫–µ–Ω–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –¥–µ–ª–µ–≥–∞—Ü—ñ—é.`)) {
                return;
            }
            
            try {
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const result = await stakingService.cancelUnbonding(
                    validatorAddress, 
                    amount, 
                    creationHeight, 
                    'Cancel unbond via QubeNode.space'
                );
                
                alert('‚úÖ Unbond —Å–∫–∞—Å–æ–≤–∞–Ω–æ! TX: ' + result.txHash);
                await loadData();
            } catch (error) {
                console.error('Cancel unbonding error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        function disconnectWallet() {
            window.location.href = 'index.html';
        }
        
        // Start
        init();
    </script>
    
    <script src="chain-config.js"></script>
    <script src="wallet-manager.js"></script>
    <script src="chain-client.js"></script>
    <script src="transaction-builder.js"></script>
    <script src="staking-service.js"></script>
    <script src="cosmos-staking.js"></script>
</body>
</html>
